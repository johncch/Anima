// Anima: A simple CSS transisions helper library
// 
// Anima is designed to enable CSS transitions via a simple JavaScript api.
// This library is designed to support:
//
// 1. Queuing a series of animations
// 2. Running a series of animations concurrently
// 3. Having callbacks at the end of each animation, or an animation frame
// 4. Cancel existing animation queues
// 5. Fallback to simple CSS styles if the browser does not support CSS transitions
//
// Anima 0.2
//
// (c) 2012 Chong Han Chua
//
// Anima may be freely distributed under the MIT license
// http://github.com/johncch/Anima
var Anima=function(){var a={},b=function(a){setTimeout(a,10)},c=!1,d=function(a){c&&window.console!==undefined&&console.log(a)},e=function(){var a=["","webkit","Moz","O","Ms"],b=document.createElement("div");for(var c=0;c<a.length;c++){var d=a[c];b.cssText="-"+d+"-transition-property:opacity;";if(typeof b.style[d+"TransitionProperty"]!="undefined")return d}return"none"}(),f=e!="none";CONSTANTS=function(){var a={};return a.Transform=e+"Transform",a.CSSTransform="-"+e.toLowerCase()+"-transform",a.TransitionProperty=e+"TransitionProperty",a.TransitionDuration=e+"TransitionDuration",a.TransitionDelay=e+"TransitionDelay",a.TransitionTimingFunction=e+"TransitionTimingFunction",a.TransitionEnd=function(){switch(e){case"Moz":return"transitionend";case"Ms":return"MSTransitionEnd";default:return e+"TransitionEnd"}}(),a.BackfaceVisibility=e+"BackfaceVisibility",a}();var g=["scale"],h=["top","left","opacity","width","height"];a.Defaults={Duration:"0.5s",Delay:"0",TimingFunction:"default"},a.parseTransitions=function(b){var c=[],d={};for(var e in b)g.indexOf(e)!=-1?(c.indexOf(CONSTANTS.CSSTransform)==-1&&c.push(CONSTANTS.CSSTransform),d[CONSTANTS.Transform]||(d[CONSTANTS.Transform]=[]),d[CONSTANTS.Transform].push(e+"("+b[e]+")")):h.indexOf(e)!=-1&&(c.indexOf(e)==-1&&c.push(e),d[e]=a.parseParams(b[e],e));return d[CONSTANTS.Transform]&&(d[CONSTANTS.Transform]=d[CONSTANTS.Transform].join(" ")),{keys:c,styles:d}},a.parseTime=function(a){return a?typeof a=="string"?a.match(/ms$/)||a.match(/s$/)?a:parseFloat(a)+"s":a+"s":null},a.parseArguments=function(a,b,c,d,e,f){var g={};return a.element?(g.element=a.element,g.properties=a.properties,g.duration=a.duration,g.delay=a.delay,g.timingFunction=a.timingFunction,g.callback=a.callback):(typeof d=="function"?(f=d,d=undefined,e=undefined):typeof d=="string"?(f=e,e=d,d=undefined):typeof e=="function"&&(f=e,e=undefined),g.element=a,g.properties=b,g.duration=c,g.delay=d,g.timingFunction=e,g.callback=f),g.element=g.element instanceof jQuery?g.element[0]:g.element,g},a.parseParams=function(a,b){var c,d;switch(b){case"width":case"height":case"left":case"top":c=["px","em","pt"];if(typeof a=="string"){for(var e=0;e<c.length;e++){var f=new RegExp(""+c[e]+"$");if(a.match(f))return a}return parseInt(a,10)+"px"}return a+"px";case"scale":return parseFloat(a);case"opacity":var g=parseFloat(a);return g=g>1?1:g,g=g<0?0:g,g;default:return a}};var i=[],j=[],k=function(a){for(var b=0;b<j.length;b++)if(j[b]===a){j.splice(b,1),d("removing runner. Remaining runners:"),d(j);return}};return a.Animation=function(b,c,e,f,g,h){var i=a.parseArguments(b,c,e,f,g,h);this.element=i.element;var j=a.parseTransitions(i.properties);this.style={},this.style[CONSTANTS.TransitionProperty]=j.keys.join(", "),this.style[CONSTANTS.TransitionDuration]=a.parseTime(i.duration)||a.Defaults.Duration,this.style[CONSTANTS.TransitionDelay]=a.parseTime(i.delay)||a.Defaults.Delay,this.style[CONSTANTS.TransitionTimingFunction]=i.timingFunction||a.Defaults.TimingFunction,this.properties=j.styles,this.callback=i.callback,this.completionHandler=null;var k=document.defaultView.getComputedStyle(this.element,null);for(var l=0;l<j.keys.length;l++){var m=j.keys[l];d("style: "+this.element.style[m]),this.element.style[m]||(this.element.currentStyle?(d("a: "+this.element.currentStyle[m]),this.element.style[m]=this.element.currentStyle[m]):(d("b: "+k.getPropertyValue(m)),this.element.style[m]=k.getPropertyValue(m)))}},a.Animation.prototype.run=function(a){if(f){this.element.style[CONSTANTS.BackfaceVisibility]="hidden";if(this.callback||a){d("setting up callback for "+CONSTANTS.TransitionEnd);var c=this.callback,e=this.element,g=this.style,h=function(){d("calling back..."),e.removeEventListener(CONSTANTS.TransitionEnd,h);for(var f in g)e.style[f]="";c&&c.call(e),a&&b(a)};this.completionHandler=h,this.element.addEventListener(CONSTANTS.TransitionEnd,this.completionHandler)}for(var i in this.style)d("executing "+i+": "+this.style[i]),this.element.style[i]=this.style[i]}for(var j in this.properties)d("executing "+j+": "+this.properties[j]),this.element.style[j]=this.properties[j];f||(this.callback&&this.callback.call(this.element),a&&b(a))},a.Animation.prototype.abort=function(){this.element.removeEventListener(CONSTANTS.TransitionEnd,this.completionHandler)},a.Animation.prototype.finish=function(a){a=a===undefined?!0:a,this.element.removeEventListener(CONSTANTS.TransitionEnd,this.completionHandler);for(var b in this.style)this.element.style[b]="";for(var c in this.properties)d("executing "+c+": "+this.properties[c]),this.element.style[c]=this.properties[c];a&&this.callback&&this.callback.call(this.element)},a.Frame=function(a){this.operations=[],this.callback=a},a.Frame.prototype.queue=function(b,c,d,e,f,g){var h=a.parseArguments(b,c,d,e,f,g);if(h.element.length&&h.element.length>=1){for(var i=0;i<h.element.length;i++){var j=h.element[i];this.queue(j,h.properties,h.duration,h.delay,h.timingFunction)}this.complete(h.callback)}else this.operations.push(new a.Animation(h.element,h.properties,h.duration,h.delay,h.timingFunction,h.callback));return this},a.Frame.prototype.run=function(a){var b=this.operations.length,c=b;d("running "+c);var e=this.callback;this.runCallback=a;var f=function(){d("run concurrent callback "+c),--c===0&&(e||a)&&(e&&e.call(),a&&a.call())};for(var g=0;g<b;g++){var h=this.operations[g];h.run(f)}},a.Frame.prototype.complete=function(a){this.callback=a},a.Frame.prototype.abort=function(){for(var a=0;a<this.operations.length;a++)this.operations[a].abort()},a.Frame.prototype.finish=function(a){a=a===undefined?!0:a;for(var b=0;b<this.operations.length;b++)this.operations[b].finish(a);a&&this.runCallback&&this.runCallback.call()},a.Runner=function(a){this.operations=a instanceof Array?a:[a],this.activeOp=null},a.Runner.prototype.run=function(a){var c=this.operations.length,e=c,f=this,g=this.operations,h=this.activeOp;this.callback=a;var i=function(){d("inside runner callback");if(--e===0)k(f),a&&a.call();else{var b=g.shift();f.activeOp=b,b.run(i)}};j.push(this);var l=this.operations.shift();this.activeOp=l,b(function(){l.run(i)})},a.Runner.prototype.abort=function(){d("aborting"),this.operations=[],this.activeOp.abort(),k(this)},a.Runner.prototype.finish=function(a){a=a===undefined?!0:a,this.activeOp.finish(a);for(var b=0;b<this.operations.length;b++)this.operations[b].finish(a);a&&this.callback&&this.callback.call(this),k(this)},a.queue=function(b,c,e,f,g,h){if(b instanceof a.Frame)i.push(b);else{var j=a.parseArguments(b,c,e,f,g,h);if(j.element.length&&j.element.length>1){var k=new a.Frame;for(var l=0;l<j.element.length;l++){var m=j.element[l];k.queue(m,j.properties,j.duration,j.delay,j.timingFunction)}d(j.callback),k.complete(j.callback),i.push(k)}else i.push(new a.Animation(j.element,j.properties,j.duration,j.delay,j.timingFunction,j.callback))}return a},a.frame=function(b,c){d("framing");var e=new a.Frame;for(var f=0;f<b.length;f++){var g=b[f];e.queue(g.element,g.properties,g.duration,g.delay,g.timingFunction,g.callback)}return e.complete(c),i.push(e),d(i),e},a.play=function(b){var c=new a.Runner(i);return i=[],c.run(b),c},a.step=function(b){var c=i.shift(),d=new a.Runner(c);return d.run(b),d},a.animate=function(b,c,d,e,f,g){a.queue(b,c,d,e,f,g),a.step()},a.abort=function(){for(var a=0;a<j.length;a++)j[a].abort()},a.finish=function(a){a=a===undefined?!0:a;for(var b=0;b<j.length;b++)j[b].finish(a)},a}();