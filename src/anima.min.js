/*
 (c) 2012-3 Chong Han Chua <johncch@outlook.com>
 Anima may be freely distributed under the MIT license
 http://github.com/johncch/Anima
*/
(function(){function r(a){return"string"==typeof a?!a.match(/ms$/)&&a.match(/s$/)?1E3*parseFloat(a):parseInt(a):a}var c={},t=function(a){setTimeout(a)},l=!1,m=function(){for(var a=["","webkit","Moz","O","Ms"],b=document.createElement("div"),f=0;f<a.length;f++){var c=a[f];b.cssText="-"+c+"-transition-property:opacity;";if("undefined"!=typeof b.style[c+"TransitionProperty"])return c}return"none"}(),s="none"!=m,h=function(){var a={};a.Transform=m+"Transform";a.CSSTransform="-"+m.toLowerCase()+"-transform";
a.TransitionProperty=m+"TransitionProperty";a.TransitionDuration=m+"TransitionDuration";a.TransitionDelay=m+"TransitionDelay";a.TransitionTimingFunction=m+"TransitionTimingFunction";a.TransitionEnd=function(){switch(m){case "Moz":return"transitionend";case "Ms":return"MSTransitionEnd";default:return m+"TransitionEnd"}}();a.BackfaceVisibility=m+"BackfaceVisibility";return a}(),u=["scale"],v="top bottom left right opacity width height".split(" ");c.Defaults={Duration:"0.5s",Delay:"0",TimingFunction:"default"};
c.parseTransitions=function(a,b){var f=[],e={},d;for(d in a)a.hasOwnProperty(d)&&(-1!=u.indexOf(d)?(-1==f.indexOf(h.CSSTransform)&&f.push(h.CSSTransform),e[h.Transform]||(e[h.Transform]=[]),e[h.Transform].push(d+"("+a[d]+")")):-1!=v.indexOf(d)&&(-1==f.indexOf(d)&&f.push(d),e[d]=c.parseParams(a[d],d,b)));e[h.Transform]&&(e[h.Transform]=e[h.Transform].join(" "));return{keys:f,styles:e}};c.parseTime=function(a){return a?"string"==typeof a?a.match(/ms$/)||a.match(/s$/)?a:parseFloat(a)+"s":a+"s":null};
c.parseArguments=function(a,b,c,e,d,n){var g={};a.element?(g.element=a.element,g.properties=a.properties,g.duration=a.duration,g.delay=a.delay,g.timingFunction=a.timingFunction,g.callback=a.callback):("function"==typeof e?(n=e,d=e=void 0):"string"==typeof e?(n=d,d=e,e=void 0):"function"==typeof d&&(n=d,d=void 0),g.element=a,g.properties=b,g.duration=c,g.delay=e,g.timingFunction=d,g.callback=n);g.element=jQuery&&g.element instanceof jQuery?g.element.get():g.element;g.element.length&&1==g.element.length&&
(g.element=g.element[0]);return g};c.parseParams=function(a,b,c){var e;switch(b){case "width":case "height":case "left":case "top":e=["px","em","pt"];if("string"==typeof a){if("="==a.charAt(1))return e=document.defaultView.getComputedStyle(c,null),b=c.style[b]||c.currentStyle[b]||e.getPropertyValue(b),b=parseInt(b,10),c=parseInt(a.substr(2),10),a="+"==a.charAt(0)?1:-1,b+c*a+"px";for(b=0;b<e.length;b++)if(a.match(RegExp(""+e[b]+"$")))return a;return parseInt(a,10)+"px"}return a+"px";case "scale":return parseFloat(a);
case "opacity":return a=parseFloat(a),a=1<a?1:a,0>a?0:a;default:return a}};var p=[],k=[],q=function(a){for(var b=0;b<k.length;b++)if(k[b]===a){k.splice(b,1);l&&console.log("[Anima] Removing runner. Remaining runners:");l&&console.log(k);break}};c.Animation=function(a,b,f,e,d,n){a=c.parseArguments(a,b,f,e,d,n);this.element=a.element;this.properties=a.properties;this.duration=a.duration;this.delay=a.delay;this.timingFunction=a.timingFunction;this.callback=a.callback;this.completionHandler=null;a=document.defaultView.getComputedStyle(this.element,
null);for(var g in this.properties)this.properties.hasOwnProperty(g)&&(this.element.style[g]||(this.element.style[g]=this.element.currentStyle?this.element.currentStyle[g]:a.getPropertyValue(g)))};c.Animation.prototype.run=function(a){l&&console.log("[Anima] (Animation) Running animation");var b=this.transitions=c.parseTransitions(this.properties,this.element);this.style={};this.style[h.TransitionProperty]=b.keys.join(", ");var f=c.parseTime(this.duration)||c.Defaults.Duration;this.style[h.TransitionDuration]=
f;var e=c.parseTime(this.delay)||c.Defaults.Delay;this.style[h.TransitionDelay]=e;this.style[h.TransitionTimingFunction]=this.timingFunction||c.Defaults.TimingFunction;if(s){if(this.callback||a){var d=this.callback,n=this.element,g=this.style,f=r(f)+r(e)+100,m=this,k=this.completionHandler=function(){l&&console.log("[Anima] (Animation) Animation completed");clearTimeout(m.timeout);n.removeEventListener(h.TransitionEnd,k);for(var b in g)g.hasOwnProperty(b)&&(n.style[b]="");d&&d.call(n);a&&setTimeout(a)};
this.element.addEventListener(h.TransitionEnd,this.completionHandler);this.timeout=setTimeout(function(){k()},f)}for(var p in this.style)this.style.hasOwnProperty(p)&&(this.element.style[p]=this.style[p])}for(var q in b.styles)b.styles.hasOwnProperty(q)&&(this.element.style[q]=b.styles[q]);s||(this.callback&&this.callback.call(this.element),a&&setTimeout(a))};c.Animation.prototype.abort=function(){clearTimeout(this.timeout);this.element.removeEventListener(h.TransitionEnd,this.completionHandler)};
c.Animation.prototype.finish=function(a){a=void 0===a?!0:a;clearTimeout(this.timeout);this.element.removeEventListener(h.TransitionEnd,this.completionHandler);for(var b in this.style)this.element.style[b]="";c.css(this.element,this.properties);a&&this.callback&&this.callback.call(this.element)};c.Frame=function(a){this.operations=[];this.callback=a};c.Frame.prototype.queue=function(a,b,f,e,d,n){a=c.parseArguments(a,b,f,e,d,n);if(a.element.length&&1<=a.element.length){for(b=0;b<a.element.length;b++)this.queue(a.element[b],
a.properties,a.duration,a.delay,a.timingFunction);this.complete(a.callback)}else this.operations.push(new c.Animation(a.element,a.properties,a.duration,a.delay,a.timingFunction,a.callback));return this};c.Frame.prototype.run=function(a){var b=this.operations.length,c=this.callback;l&&console.log("[Anima] (Frame) running %d animations concurrently",b);this.runCallback=a;for(var e=function(){l&&console.log("[Anima] (Frame) Callback at length %d",b);0===--b&&(c&&c.call(),a&&a.call())},d=0;d<b;d++)this.operations[d].run(e)};
c.Frame.prototype.complete=function(a){this.callback=a};c.Frame.prototype.abort=function(){for(var a=0;a<this.operations.length;a++)this.operations[a].abort()};c.Frame.prototype.finish=function(a){a=void 0===a?!0:a;for(var b=0;b<this.operations.length;b++)this.operations[b].finish(a);a&&this.runCallback&&this.runCallback.call()};c.Runner=function(a){this.operations=a instanceof Array?a:[a];this.activeOp=null};c.Runner.prototype.run=function(a){function b(){l&&console.log("[Anima] (Runner) Callback with cbLen %d",
e);if(0===--e)q(c),a&&a.call();else{var d=c.operations.shift();c.activeOp=d;d.run(b)}}var c=this,e=this.operations.length;this.callback=a;l&&console.log("[Anima] (Runner) Start of run");k.push(this);l&&console.log("[Anima] (Runner) Number of runners");l&&console.log(k);var d=this.operations.shift();this.activeOp=d;t(function(){d.run(b)})};c.Runner.prototype.abort=function(){l&&console.log("[Anima] (Runner) Aborting");this.operations=[];this.activeOp.abort();q(this)};c.Runner.prototype.finish=function(a){a=
void 0===a?!0:a;this.activeOp.finish(a);for(var b=0;b<this.operations.length;b++)this.operations[b].finish(a);a&&this.callback&&this.callback.call(this);q(this)};c.queue=function(a,b,f,e,d,h){if(a instanceof c.Frame)p.push(a);else if(a=c.parseArguments(a,b,f,e,d,h),a.element.length&&1<a.element.length){b=new c.Frame;for(f=0;f<a.element.length;f++)b.queue(a.element[f],a.properties,a.duration,a.delay,a.timingFunction);l&&console.log(a.callback);b.complete(a.callback);p.push(b)}else p.push(new c.Animation(a.element,
a.properties,a.duration,a.delay,a.timingFunction,a.callback));return c};c.frame=function(a,b){a=a||[];for(var f=new c.Frame,e=0;e<a.length;e++){var d=a[e];f.queue(d.element,d.properties,d.duration,d.delay,d.timingFunction,d.callback)}f.complete(b);p.push(f);return f};c.play=function(a){var b=new c.Runner(p);p=[];b.run(a);return b};c.step=function(a){var b=p.shift(),b=new c.Runner(b);b.run(a);return b};c.animate=function(a,b,f,e,d,h){c.queue(a,b,f,e,d,h);c.step()};c.abort=function(){for(var a=0;a<
k.length;a++)k[a].abort()};c.finish=function(a){a=void 0===a?!0:a;for(var b=0;b<k.length;b++)k[b].finish(a)};c.css=function(a,b){var f=jQuery&&a instanceof jQuery?a.get():a;f.length&&1==f.length&&(f=f[0]);var e=c.parseTransitions(b,f),d;for(d in e.styles)f.style[d]=e.styles[d]};this.Anima=c})(this);
